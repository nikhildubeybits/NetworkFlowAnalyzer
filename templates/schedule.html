<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Capture - Network SecureFlow Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1a202c;
            --secondary-color: #2d3748;
            --accent-color: #38a169;
            --text-color: #e2e8f0;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            background: linear-gradient(-45deg, #121826, #1a202c, #2d3748, #1a202c);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            color: var(--text-color);
            font-family: 'Roboto Mono', monospace;
        }
        .dashboard-header {
            background: linear-gradient(-45deg, #1a202c, #2d3748, #1a202c, #2d3748);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            color: #edf2f7;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--secondary-color);
        }
        .module-card {
            background: rgba(45, 55, 72, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 3rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            padding: 2rem;
            text-align: center;
        }
        .timer-display {
            font-size: 5rem;
            font-weight: 700;
            margin: 2rem 0;
            color: var(--accent-color);
            text-shadow: 0 0 15px rgba(56, 161, 105, 0.5);
        }
        .btn-module {
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-weight: 700;
            transition: all 0.3s ease;
            border: none;
        }
        .footer {
            background: var(--primary-color);
            color: var(--text-color);
            padding: 1.5rem 0;
            margin-top: 3rem;
            text-align: center;
            border-top: 1px solid var(--secondary-color);
            position: absolute;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-clock-history"></i> Schedule Packet Capture</h1>
                    <p class="lead mb-0">Run a timed capture and download the results.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="/" class="btn btn-outline-light"><i class="bi bi-arrow-left-circle"></i> Back to Dashboard</a>
                        <a href="/logout" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="module-card">
                    <!-- Setup View -->
                    <div id="setup-view">
                        <h2>Set Capture Duration</h2>
                        <p>Enter the duration in minutes for the packet capture session.</p>
                        <div class="d-flex justify-content-center align-items-center gap-3 mt-4">
                            <input type="number" id="capture-duration-min" class="form-control form-control-lg" placeholder="e.g., 5" style="width: 150px;">
                            <span>minutes</span>
                            <button class="btn btn-success btn-lg btn-module" onclick="startScheduledCapture()">Start Capture</button>
                        </div>
                    </div>

                    <!-- Capturing View -->
                    <div id="capturing-view" style="display: none;">
                        <h2 id="status-text">Capturing Packets...</h2>
                        <div id="timer-display" class="timer-display">00:00</div>
                        <p>The capture will stop automatically. You can also stop it manually.</p>
                        <button class="btn btn-danger btn-lg btn-module" onclick="stopCapture()">Stop Capture</button>
                    </div>

                    <!-- Results View -->
                    <div id="results-view" style="display: none;">
                        <h2 id="result-message">Capture Complete!</h2>
                        <p>Your timed packet capture has finished. You can now download the log file.</p>
                        <div id="download-container" class="mt-4">
                            <!-- Download link will be injected here -->
                        </div>
                        <button class="btn btn-primary btn-lg btn-module mt-4" onclick="resetView()">Schedule Another Capture</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="mb-0">Network SecureFlow Analyzer Â© 2025 developed by BITS Pilani student nikhil dubey</p>
        </div>
    </footer>

    <script>
        let captureInterval = null;
        let countdownInterval = null;
        let capturedPackets = [];
        let logFileName = '';

        function startScheduledCapture() {
            const durationInput = document.getElementById('capture-duration-min');
            const durationMinutes = parseInt(durationInput.value, 10);

            if (isNaN(durationMinutes) || durationMinutes <= 0) {
                alert('Please enter a valid number of minutes.');
                return;
            }

            const durationSeconds = durationMinutes * 60;
            capturedPackets = [];

            // Switch views
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('capturing-view').style.display = 'block';

            // Start fetching packets every 2 seconds
            captureInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/capture');
                    const packets = await response.json();
                    capturedPackets.push(...packets);
                } catch (error) {
                    console.error("Error fetching packets:", error);
                }
            }, 2000);

            // Start countdown timer
            let remaining = durationSeconds;
            updateTimerDisplay(remaining);
            countdownInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay(remaining);
                if (remaining <= 0) {
                    stopCapture(true); // Capture completed successfully
                }
            }, 1000);
        }

        function stopCapture(isComplete = false) {
            clearInterval(captureInterval);
            clearInterval(countdownInterval);
            captureInterval = null;
            countdownInterval = null;

            document.getElementById('capturing-view').style.display = 'none';
            document.getElementById('results-view').style.display = 'block';
            document.getElementById('result-message').textContent = isComplete ? 'Capture Complete!' : 'Capture Stopped by User';

            if (capturedPackets.length > 0) {
                const csvContent = convertToCSV(capturedPackets);
                const logBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const logUrl = URL.createObjectURL(logBlob);
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                logFileName = `scheduled-capture-${timestamp}.csv`;
                document.getElementById('download-container').innerHTML = `
                    <a href="${logUrl}" download="${logFileName}" class="btn btn-info btn-lg btn-module"><i class="bi bi-download"></i> Download Log File</a>
                    <button class="btn btn-primary btn-lg btn-module" onclick="uploadToAWS(this)"><i class="bi bi-cloud-arrow-up"></i> Store in AWS</button>`;
            } else {
                document.getElementById('download-container').innerHTML = `<p class="text-warning">No packets were captured during the session.</p>`;
            }
        }

        function updateTimerDisplay(seconds) {
            const min = Math.floor(seconds / 60).toString().padStart(2, '0');
            const sec = (seconds % 60).toString().padStart(2, '0');
            document.getElementById('timer-display').textContent = `${min}:${sec}`;
        }

        function convertToCSV(data) {
            if (data.length === 0) {
                return "";
            }
            const headers = Object.keys(data[0]);
            const csvRows = [];
            csvRows.push(headers.join(',')); // Add header row

            for (const row of data) {
                const values = headers.map(header => {
                    // Escape double quotes by doubling them, and wrap value in double quotes
                    const escaped = ('' + row[header]).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }

        function resetView() {
            document.getElementById('results-view').style.display = 'none';
            document.getElementById('setup-view').style.display = 'block';
            document.getElementById('capture-duration-min').value = '';
            logFileName = '';
        }

        async function uploadToAWS(buttonElement) {
            if (capturedPackets.length === 0 || !logFileName) {
                alert("No capture data available to upload.");
                return;
            }

            buttonElement.disabled = true;
            buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i> Uploading...';

            try {
                const csvContent = convertToCSV(capturedPackets);
                const logBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

                // 1. Calculate the file hash using the browser's crypto API
                const buffer = await logBlob.arrayBuffer();
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const fileHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

                // 2. Create FormData and append both the file and the hash
                const formData = new FormData();
                formData.append('logFile', logBlob, logFileName);
                formData.append('fileHash', fileHash);

                // 3. Send the request
                const response = await fetch('/api/upload-to-s3', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to upload.');
                }
                alert(result.message); // Success message
                buttonElement.innerHTML = '<i class="bi bi-check-lg"></i> Uploaded!';
            } catch (error) {
                console.error("Error uploading to AWS:", error);
                alert(`Upload failed: ${error.message}`);
                buttonElement.disabled = false; // Re-enable on failure
                buttonElement.innerHTML = '<i class="bi bi-cloud-arrow-up"></i> Store in AWS';
            }
        }
    </script>
</body>
</html>